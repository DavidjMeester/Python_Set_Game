import os
import random
import pygame

class Set:
    colors = ['red', 'green', 'purple']
    symbols = ['oval', 'squiggle', 'diamond']
    shadings = ['filled', 'shaded', 'empty']
    numbers = ['1', '2', '3']

    def __init__(self, name):
        self.name = name.lower()
        self.features = self.parse_name_to_features(self.name)

    def parse_name_to_features(self, name):
        #Find color
        color = next(i for i, c in enumerate(self.colors) if c in name)
        #Find symbol
        symbol = next(i for i, s in enumerate(self.symbols) if s in name)
        #Find shading
        shading = next(i for i, sh in enumerate(self.shadings) if sh in name)
        #Find number
        number_char = name[-1]
        number = int(number_char) - 1
        return [color, symbol, shading, number]

    def __repr__(self):
        return str(self.features)  

kaart_pad = "kaarten"

alle_gif_kaarten = [f for f in os.listdir(kaart_pad) if f.endswith(".gif")]
bestandsnaam = alle_gif_kaarten[0]
setkaart = Set(bestandsnaam.replace(".gif", ""))
print(f"{bestandsnaam} â†’ {setkaart}")

def is_set(card1,card2,card3): #input: tuples
        for x in range(4):
            totalvalue = int(card1[x] + card2[x] + card3[x])
            if totalvalue % 3 != 0:
                return False
        return True

def find_one_set(cards): #input: tuple met tuples
    cards_set = set(cards) #sneller
    def missing_card(c1, c2): #zoekt de kaart die met c1 en c2 een set vormt
        return tuple((- (c1[x] + c2[x]) % 3) for x in range(4))
    for i in range(len(cards)):
        for x in range(i + 1, len(cards)):
            m = missing_card(cards[i], cards[x])
            if m in cards_set:
                return (cards[i], cards[x], m)
    return None

def find_all_sets(cards): #input: tuple met tuples
    cards_set = set(cards) #sneller
    sets = set()
    def missing_card(c1, c2): #zoekt de kaart die met c1 en c2 een set vormt
        return tuple((- (c1[x] + c2[x]) % 3) for x in range(4))
    for i in range(len(cards)):
        for x in range(i + 1, len(cards)):
            m = missing_card(cards[i], cards[x])
            if m in cards_set:
                s_e_t = tuple(sorted((cards[i],cards[x],m))) #om duplicates te voorkomen
                sets.add(s_e_t) 
    if sets:
        return list(sets)
    return None


pygame.init()
screen = pygame.display.set_mode((1080, 720))
clock = pygame.time.Clock()
running = True

# 1. Lees alle .gif bestanden in de map
kaart_pad = "kaarten"
alle_gif_kaarten = [f for f in os.listdir(kaart_pad) if f.endswith(".gif")]
bestandsnaam = alle_gif_kaarten[0]
# 2. Kies willekeurig 12 kaarten
gekozen_kaarten = random.sample(alle_gif_kaarten, 12)
setkaart = Set(bestandsnaam.replace(".gif", ""))
# 3. Laad kaarten met posities en selectie-status
kaarten = []
for i, bestandsnaam in enumerate(gekozen_kaarten):
    pad = os.path.join(kaart_pad, bestandsnaam)
    afbeelding = pygame.image.load(pad)
    
    x = 50 + (i % 4) * 150
    y = 50 + (i // 4) * 215
    rect = pygame.Rect(x, y, 100, 200)
    kaarten.append({
        "image": afbeelding,
        "rect": rect,
        "selected": False,
        "set": setkaart
    })

while running:
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False
        
        elif event.type == pygame.MOUSEBUTTONDOWN:
            for kaart in kaarten:
                if kaart["rect"].collidepoint(event.pos):
                    kaart["selected"] = not kaart["selected"]

    geselecteerd = [k for k in kaarten if k["selected"]]
    if len(geselecteerd) == 3:
        vectors = [k["vector"] for k in geselecteerd]
        if is_set(*vectors):
            for k in geselecteerd:
                k["is_valid_set"] = True
        else:
            for k in geselecteerd:
                k["is_valid_set"] = False

    screen.fill((30, 100, 100))

    # Teken alle kaarten
    for kaart in kaarten:
        screen.blit(kaart["image"], kaart["rect"].topleft)
        if kaart["selected"]:
            pygame.draw.rect(screen, (255, 0, 0), kaart["rect"], 4)

    pygame.draw.line(screen, (255, 255, 255), (660, 0), (660, 720), 15)

    pygame.display.flip()
    clock.tick(60)

pygame.quit()
